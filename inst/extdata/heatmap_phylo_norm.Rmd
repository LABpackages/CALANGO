---
title: "Heatmap - species clustering by phylogeny"
output: html_document
---

```{r Heatmaps, echo = F, warnings = F, message = F}
###Prepare data.frame to plot

##getting data frame linking genome IDs to groups and short names
y.name <- defs$y.name
groups <- defs$groups
short.name <- defs$short.name
names <- data.frame(y.name, groups, short.name)
colnames(names) <- c("genomeID", "group", "shortName")

##DEBUG
#y.name
#groups
#short.name
#names


##getting relevant annotation IDs to plot only them
ids <- as.vector(defs$sig_IDs)

##DEBUG
#ids

#getting annotation frequencies for annotation IDs
tmp <- defs$y[as.vector(ids)]
#tmp <- data.frame(sapply(defs$y[as.vector(ids)], function(x) ifelse(x > 0, 1, 0)))
norm <- tmp
norm <- tmp/defs$denominator
#rm(tmp)

#replacing genome IDs by user-defined names
rownames(norm) <- names$shortName[match(rownames(norm), names$genomeID)]


##DEBUG
#norm

#getting a heatmaply-compatible tree

tree <- defs$tree

#replacing genome IDs by short names
tree$tip.label<-names[[3]][match(tree$tip.label, names[[1]])]

#2char
tree$tip.label <- sapply(tree$tip.label, function(x) as.character(x))

#final tree must be a dendrogram and a dendextend object
tree2 <- as.dendrogram(ape::as.phylo(tree))
tree_final <- dendextend::set(tree2, "branches_lwd", 0.4)

##DEBUG
#plot(tree2)

#colnames(norm) <- paste0(ids, " - ", output$annotation.cor[ids])

mat <- as.matrix(norm)
ord.mat <- mat[tree$tip.label,]
rm(norm)

#to create custom hover text by adding annotation definition
onmouseover <- as.data.frame(ord.mat)
onmouseover[] <- lapply(colnames(onmouseover), function(colname) {
    paste0("definition: ", defs$annotation.cor[colname], "\n")
})

##DEBUG
#ord.mat

#color pallete for heatmap
my_palette <- colorRampPalette(c("white","blue"))(n = 51)

#establishing colors for groups
jColors <-
   with(names,
        data.frame(LABEL = levels(group),
                   COLOR = I(RColorBrewer::brewer.pal(nlevels(group), name = 'Set1'))))

##DEBUG
#jColors

#coloring species by group color
tmp <- list()
tmp$species <- rownames(ord.mat)
tmp$group <- names$group[match(tmp$species, names$shortName)]
tmp$COLOR <- jColors$COLOR[match(tmp$group, jColors$LABEL)]
species2color <- unique(as.data.frame(tmp)[,c("species","COLOR")])
species2group <- unique(as.data.frame(tmp)[,c("species","group")])
#rm(tmp)

##DEBUG
#species2color

#quantile normalization
#tmp <- normalize.quantiles(as.matrix(ord.mat))
#colnames(tmp) <- colnames(ord.mat)
#rownames(tmp) <- rownames(ord.mat)
#ord.norm.mat <- tmp
#rm(tmp)

#computing distance for row clustering
distance2 = dist(as.matrix(t(heatmaply::normalize(as.data.frame(ord.mat)))), method = "manhattan")
cluster2 = hclust(distance2, method = "average")
#cluster2_final = dendextend::set(as.dendrogram(hclust(distance2, method=c("average"))), "branches_lwd", 0.4)

##DEBUG
#plot(cluster2_final)


#plot(tree_final)

#Plot

#norm

heatmaply::heatmaply(
                     t(heatmaply::normalize(as.data.frame(ord.mat))),
                     Colv = tree2,
                     col = my_palette,
#                     row_dend_left = TRUE,
                     plot_method= "ggplot",
#                     cexCol = 0.8,
                     custom_hovertext = t(onmouseover),
                     subplot_widths=c(0.9, 0.1),
                     subplot_heights=c(0.08, 0.02, 0.90),
#                     subplot_heights=c(0.05, 0.01, 0.94),
#                     col_side_colors = NULL,
#                     row_side_colors = species2group$group,
                     col_side_colors = data.frame("Groups" = species2group$group, check.names=FALSE)
                     ) %>% plotly::layout(width=25*(nrow(ord.mat)), height=20*(ncol(ord.mat)))

#                     code used to generate pdf plots for article
#                     Colv = tree_final,
#                     file="heatmap_norm.pdf",
#                     Rowv = cluster2,
#                     branches_lwd = 0.4,
#                     col = my_palette,
#                     row_dend_left = TRUE,
#                     plot_method= "ggplot",
#                     cexRow = 0.6,
#                    width = 1000,
#                    height = 1000,
#                     custom_hovertext = t(onmouseover),
#                     subplot_widths=c(0.9, 0.1),
#                     subplot_heights=c(0.08, 0.02, 0.90),
#                    k_row = NA,
#                     showticklabels = FALSE,
#                     subplot_heights=c(0.05, 0.01, 0.94),
#                     col_side_colors = NULL,
#                     row_side_colors = species2group$group,
#                     col_side_colors = data.frame("Groups" = species2group$group, check.names=FALSE)
#                     ) %>% plotly::layout(width=25*(nrow(ord.mat)), height=20*(ncol(ord.mat)))

```
