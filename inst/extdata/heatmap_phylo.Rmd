---
title: "Heatmap - species clustering by phylogeny"
output: html_document
---

```{r Heatmaps, echo = FALSE, warnings = FALSE, message = FALSE}
###Prepare data.frame to plot

##getting data frame linking genome IDs to groups and short names
# y.name <- defs$y.name
# groups <- defs$groups
# short.name <- defs$short.name
# names <- data.frame(y.name, groups, short.name)
# colnames(names) <- c("genomeID", "group", "shortName")
mynames <- data.frame(genomeID  = defs$y.name, 
                      group     = defs$groups, 
                      shortName = defs$short.name)

##DEBUG
#y.name
#groups
#short.name
#names


##getting relevant annotation IDs to plot only them
ids <- as.vector(df_cutoff$name)

##DEBUG
#ids

#getting annotation frequencies for annotation IDs
tmp <- defs$y[as.vector(ids)]
norm <- tmp / defs$denominator
rm(tmp)

#replacing genome IDs by user-defined names
rownames(norm) <- mynames$shortName[match(rownames(norm), mynames$genomeID)]


##DEBUG
#norm

#getting a heatmaply-compatible tree

tree <- defs$tree

#replacing genome IDs by short names
tree$tip.label <- mynames$shortName[match(tree$tip.label, mynames$genomeID)]

#2char
tree$tip.label <- sapply(tree$tip.label, function(x) as.character(x))

#final tree must be a dendrogram and a dendextend object
tree2 <- stats::as.dendrogram(ape::as.phylo(tree))
tree_final <- dendextend::set(tree2, what = "branches_lwd", value = 1)

##DEBUG
#plot(tree2)


mat     <- as.matrix(norm)
ord.mat <- mat[tree$tip.label,]
rm(norm)

#to use ID + description as column names, does not work if names are too long (figure is not printed)
#colnames(ord.mat) <- paste0(ids, " - ", output$annotation.cor[ids])

#to create custom hover text
#onmouseover <- ord.mat
#onmouseover[] <- paste0(ids, " - ", defs$annotation.cor[ids])
#onmouseover[] <- lapply(colnames(ord.mat), function(colname) {
#    paste0(colname, ": ", ord.mat[, colname], "\n")
#})
#defs$onmouseover <- onmouseover
#rm(onmouseover)

##DEBUG
#ord.mat

#color pallete for heatmap
my_palette <- grDevices::colorRampPalette(c("white", "blue"))(n = 51)

#establishing colors for groups
jColors <- data.frame(LABEL = levels(mynames$group),
                      COLOR = I(KOMODO2_brewer_pal(nlevels(mynames$group), 
                                                   name = 'Set1')))

##DEBUG
#jColors

#coloring species by group color
tmp <- data.frame(species = rownames(ord.mat),
                  group   = mynames$group[match(tmp$species, mynames$shortName)],
                  COLOR   = jColors$COLOR[match(tmp$group, jColors$LABEL)])

species2color <- unique(tmp[, c("species", "COLOR")])
species2group <- unique(tmp[, c("species", "group")])
#rm(tmp)

##DEBUG
#species2color

#quantile normalization
#tmp <- normalize.quantiles(as.matrix(ord.mat))
#colnames(tmp) <- colnames(ord.mat)
#rownames(tmp) <- rownames(ord.mat)
#ord.norm.mat <- tmp
#rm(tmp)

#computing distance for column clustering
distance2 <- stats::dist(as.matrix(t(ord.mat)), method = "euclidean")
cluster2  <- stats::hclust(distance2, method = "average")
#cluster2_final = dendextend::set(as.dendrogram(hclust(distance2, method=c("average"))), "branches_lwd", 1)

##DEBUG
#plot(cluster2_final)


#plot(tree_final)

#Plot

#norm

heatmaply::heatmaply(
  heatmaply::normalize(as.data.frame(ord.mat)),
  # file="heatmap_p.html",
  # row_dend_left = TRUE,
  # custom_hovertext = defs$onmouseover,
  # col_side_colors = NULL,
  # row_side_colors = species2group$group,
  Rowv            = tree2,
  Colv            = cluster2,
  col             = my_palette,
  plot_method     = "plotly",
  cexCol          = 1,
  row_side_colors = data.frame("Groups" = species2group$group,
                               check.names = FALSE)) %>% 
  plotly::layout(width = 1200, height = 600)


#%>%
#                     plotly::colorbar(tickfont = list(size = 20), titlefont = list(size = 20), which = 1) %>%
#                     plotly::colorbar(tickfont = list(size = 20), titlefont = list(size = 20), which = 2)

## The viridis color scale
## The categorical color scale
## Change xaxis font family to Courier. I'm not sure which fonts are supported unfortunately, this is just one example
#                     layout(xaxis=list(tickfont = list(family = "Courier"))))
#                     RowSideColors = species2group$group,
#                     custom_hovertext = mat,


#heatmaply::heatmaply(
#  mtcars, 
#  xlab = "Features",
#  ylab = "Cars", 
#  scale = "column",
#  main = "Data transformation using 'scale'"
#)

```
