---
title: "Komodo Results Report"
output: html_document
---


Correlation Plots :

```{r Correlation Plots,echo=F,warnings=F,message=F}
library(plotly)
library(ggplot2)
library(scales)
library(DT)
cutoff=0.2; #only for corrected contrasts as of now. 
#prepare data.frame to plot
wd<-getwd();
sumY<-KOMODO2$sum
sumY<-sumY[!sumY==0]
Y<-KOMODO2$y[,colSums(KOMODO2$y)!=0]

df<-rbind(KOMODO2$contrasts.corrected[order(names(KOMODO2$contrasts.corrected))],
	  KOMODO2$results.correlations.pvalue.pearson[order(names(KOMODO2$results.correlations.pvalue.pearson))],
	  (sumY[order(names(sumY))]),
	  KOMODO2$results.correlations.pvalue.spearman[order(names(KOMODO2$results.correlations.pvalue.spearman))],
	  KOMODO2$results.correlations.pvalue.kendall[order(names(KOMODO2$results.correlations.pvalue.kendall))],
	  Y[,order(colnames(Y))])
rownames(df)[1:5]<-c("corrected_contrasts",
		     "PearsonCorrelation",
		     "size",
		     "SpearmanCorrelation",
		     "KendallCorrelation")
df<-as.data.frame(t(df))
description<-unlist(KOMODO2$annotation.cor)
description<-description[order(names(description))]
df$description<-description
df$name<-rownames(df)
#filter
df_cutoff<-df[df$corrected_contrasts<cutoff,]
#plot
p<-ggplot(df_cutoff,aes(x=-log10(corrected_contrasts),y=-log10(SpearmanCorrelation),label=name,description=description))+
        geom_point(aes(size = size),alpha=0.5)+
        theme_bw() + ggtitle("Spearman") +
        labs(x="-log10(Corrected contrasts)",y='-log10(Spearman correlation q-value)')
pl1 <- ggplotly(p,tooltip=c('size','name','description'))

p<-ggplot(df_cutoff,aes(x=-log10(corrected_contrasts),y=-log10(KendallCorrelation),label=name,description=description))+
        geom_point(aes(size = size),alpha=0.5)+
        theme_bw() + ggtitle("Kendall") +
        labs(x="-log10(Corrected contrasts)",y='-log10(Kendall correlation q-value)')
pl2 <- ggplotly(p,tooltip=c('size','name','description'))

p<-ggplot(df_cutoff,aes(x=-log10(corrected_contrasts),y=-log10(PearsonCorrelation),label=name,description=description))+
        geom_point(aes(size = size),alpha=0.5)+
        theme_bw() + ggtitle("Pearson") +
        labs(x="-log10(Corrected contrasts)",y='-log10(Pearson correlation q-value)')
pl3 <- ggplotly(p,tooltip=c('size','name','description'))

htmltools::tagList(pl1,pl2,pl3)
```

```{r Multiplot,echo=F,warning=FALSE}
Xdf <- KOMODO2$x
#nice scatterplot, confidence intervals
names(Xdf) <- "X_var"
dir.create("result_Plots");
lis<-list();
for ( i in  df_cutoff$name ){ # get filtered to plot a lot
	file<-paste0(wd,'/result_Plots/',i,'.html');
	Xdf$feature <- KOMODO2$y[,i]/KOMODO2$denominator
	model1 <- lm(Xdf$feature ~ Xdf$X_var)
	conf_interval <- predict(model1, newdata=data.frame(QUET=3), interval="confidence", level = 0.95)
	temp_var <- predict(model1, interval="prediction")
	new_Xdf <- cbind(Xdf, temp_var)
	ID=row.names(new_Xdf)
	p2 <- ggplot(new_Xdf, aes(x = X_var, y = feature,label=ID)) + geom_point()+
		geom_line(aes(y=lwr), color = "red", linetype = "dashed")+
		geom_line(aes(y=upr), color = "red", linetype = "dashed")+
		geom_smooth(method = "lm", se = TRUE) +
		theme_bw() +
		ggtitle(i)	
	p2ly<-ggplotly(p2,tooltip=c('label','X_var','Normalized feature'));
	htmlwidgets::saveWidget(p2ly,file=file,title=i,libdir='lib',selfcontained=F)

}
```

Results table, some columns are not visible by default. 
```{r Table,echo=F}
dtable<- df_cutoff %>% mutate (name = paste0('<a  target=_blank href=', wd,'/result_Plots/',name,'.html>', name,'</a>' )  ) #build link to plots
dtable<-datatable(dtable,escape=F,filter = 'bottom',extensions = 'Buttons', options = list(dom = 'Bfrtip', buttons = c('colvis','csv'),columnDefs = list(list(visible=FALSE, targets=4:(length(df_cutoff)-2) )))) # prepare table
#TODO path need to be set
dtable
```
